# EarthLord 产品需求文档（PRD）

## 1. 产品概述

### 1.1 产品名称
EarthLord（地球领主）

### 1.2 产品定位
一款基于真实GPS定位的末日生存+领地策略手游，玩家通过现实世界中的步行来圈地、探索、搜刮资源，并在虚拟世界中建造家园、与其他玩家交易和通讯。

### 1.3 目标平台
iOS（Apple App Store 全球175个国家和地区）

### 1.4 核心理念
- **Walk to Earn**：走路即收益，鼓励玩家走出户外
- **虚实结合**：真实地理位置映射游戏世界
- **希望朋克**：废土之上的新生，绝望中的希望

### 1.5 世界观
2048年，"终末战争"爆发，全球文明在72小时内崩塌，99%人口消失。2051年，幸存者从废墟中走出，《新开拓者协议》颁布：**"凡以双足丈量之无主土地，皆为开拓者所有。"** 玩家作为开拓者，在废土上用双脚重建家园。

### 1.6 目标用户
- 喜欢户外运动的玩家
- 生存/策略类游戏爱好者
- 宝可梦GO类LBS游戏用户
- 18-35岁，全球市场

---

## 2. 核心游戏循环

```
登录注册 → 圈地占领 → 探索搜刮 → 获得资源
   ↑                                ↓
   │         资源用途：
   │         • 建造建筑（消耗资源）
   │         • 交易换物（流通资源）
   │         • 生存消耗（食物/水）
   │                                ↓
   └──────── 通讯社交 ← 成就排行 ← 发展壮大
```

**关键逻辑：先圈地有了"家"，再探索获得"资源"，然后才能建造和交易。**

---

## 3. 功能需求

### 3.1 登录注册系统

| 项目 | 说明 |
|------|------|
| 优先级 | P0（必须） |
| 技术方案 | Supabase Auth |

**功能描述：**
- 支持三种登录方式：
  - 邮箱注册（用户名+密码）
  - Apple 登录（OAuth）
  - Google 登录（OAuth）
- 登录后进入游戏主界面
- 支持会话管理、多设备登录
- 支持密码重置、邮箱验证

**验收标准：**
- 新用户可通过任意一种方式完成注册并进入游戏
- OAuth登录一键完成，无需额外填写信息
- 登录状态持久化，退出App后重新打开无需重复登录

---

### 3.2 GPS圈地系统

| 项目 | 说明 |
|------|------|
| 优先级 | P0（必须） |
| 技术方案 | Apple MapKit + CoreLocation |

**功能描述：**
- 打开App显示末日风格卫星地图
- 点击"开始圈地"后，GPS实时追踪玩家移动轨迹
- 移动过程中地图上绘制蓝色轨迹线
- 走回起点附近时轨迹自动闭合，形成绿色多边形
- 系统验证圈地合法性：
  - 反作弊检测（速度异常、位置跳变）
  - 领地重叠检测（不与其他玩家领地重叠）
- 验证通过后领地永久归属玩家，显示面积

**验收标准：**
- GPS轨迹绘制流畅，延迟 < 1秒
- 闭合检测准确（起点终点距离 < 50米自动闭合）
- 面积计算准确
- 重叠检测正确，不允许领地重叠

---

### 3.3 领地管理

| 项目 | 说明 |
|------|------|
| 优先级 | P0（必须） |
| 技术方案 | Supabase + PostGIS |

**功能描述：**
- 领地详情页展示：名称、面积、建筑数量
- 玩家可为领地命名
- "允许交易"开关：开启后100米范围内的其他玩家可看到挂单并交易
- 领地活跃度要求：30天内开始建设，90天内保持活跃，否则回收

**验收标准：**
- 领地数据云端存储，多设备同步
- 地理空间查询响应 < 500ms

---

### 3.4 POI发现与搜刮

| 项目 | 说明 |
|------|------|
| 优先级 | P0（必须） |
| 技术方案 | Apple MapKit POI + 地理围栏 |

**功能描述：**
- 基于真实地理位置，自动识别附近的POI（兴趣点）
- 玩家接近POI时弹出提示"发现兴趣点"
- 点击"搜刮"获取对应资源：
  - 医院/药店 → 药品
  - 超市/餐厅 → 食物
  - 工厂/工地 → 金属
  - 公园/林地 → 木材
  - 银行/珠宝店 → 稀有材料
- 搜刮完成后显示"探索成就"页面：探索距离、时长、获得物品

**验收标准：**
- POI识别基于苹果MapKit真实数据
- 地理围栏触发准确（进入POI 100米范围内触发）
- 资源发放与POI类型匹配

---

### 3.5 背包系统

| 项目 | 说明 |
|------|------|
| 优先级 | P0（必须） |
| 技术方案 | 本地优先 + Supabase同步 |

**功能描述：**
- 背包容量上限：100格
- 显示当前容量使用进度（如 41/100）
- 物品分类浏览和筛选
- 物品使用功能
- 本地优先架构：离线可查看和使用，联网后自动同步

**验收标准：**
- 背包数据离线可用
- 网络恢复后自动同步，无数据丢失
- 容量满时提示玩家

---

### 3.6 建造系统

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |

**功能描述：**
- 15种建筑，分4大类：
  - **生存类**：篝火、庇护所
  - **储存类**：小仓库、中仓库
  - **生产类**：农田、工作台
  - **能源类**：太阳能板、风力发电机
- 建筑分3个等级：Tier 1（生存基础）→ Tier 2（功能扩展）→ Tier 3（高级设施）
- 建造前检查资源是否充足
- 建造时拖动图标选择领地内位置
- 资源不足时提示"建造失败，资源不足"

**验收标准：**
- 建造消耗正确扣除背包资源
- 建筑正确放置在领地范围内
- 资源不足时无法建造并给出明确提示

---

### 3.7 建筑状态管理

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |

**功能描述：**
- 建筑状态机：建造中 → 待激活 → 运行中 → 损坏
- 不同状态下可执行的操作不同
- 支持升级、维修操作
- 只有"运行中"状态的建筑可升级

**验收标准：**
- 状态流转逻辑正确
- 非法操作给出明确提示（如"只能升级激活状态的建筑"）

---

### 3.8 交易系统

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |

**功能描述：**
- 以物易物交易模式
- 发布挂单：选择"我提供"和"我需要"的物品
- 基于位置的交易发现：进入其他玩家领地100米范围内可看到挂单
- 接受交易后双方物品自动交换

**验收标准：**
- 交易过程数据一致性，无物品丢失或复制
- 位置限制正确（100米范围）
- 挂单列表实时更新

---

### 3.9 消息中心

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |

**功能描述：**
- 系统消息推送：
  - 生存指南
  - 每日任务
  - 官方公告
- 消息列表展示，支持已读/未读状态

**验收标准：**
- 消息推送及时
- 消息列表按时间排序

---

### 3.10 公共频道聊天

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |
| 技术方案 | Supabase Realtime |

**功能描述：**
- 基于位置的公共聊天室
- 覆盖范围 3km：只有方圆3km内的玩家可互相看到消息
- 实时消息推送，无需手动刷新
- 显示消息发送者、时间

**验收标准：**
- 消息实时送达（延迟 < 2秒）
- 超出3km范围的玩家无法看到消息
- 聊天记录持久化

---

### 3.11 频道管理

| 项目 | 说明 |
|------|------|
| 优先级 | P2（一般） |

**功能描述：**
- 创建自定义频道
- 浏览频道列表：频道名、距离、在线人数
- 加入/退出频道
- 频道内聊天

**验收标准：**
- 频道创建和管理功能正常
- 频道列表实时显示在线人数

---

### 3.12 PTT呼叫

| 项目 | 说明 |
|------|------|
| 优先级 | P2（一般） |

**功能描述：**
- 模拟真实无线电的Push to Talk功能
- 长按麦克风按钮录音，松开发送
- 显示频率信息（如"438.000"公共频道）
- 语音消息实时推送给频道内玩家

**验收标准：**
- 语音录制和发送流畅
- 语音消息实时推送

---

### 3.13 通讯设备等级

| 项目 | 说明 |
|------|------|
| 优先级 | P2（一般） |

**功能描述：**
- 设备升级路径：收音机 → 对讲机 → 营地电台 → 卫星通讯
- 各等级能力限制：
  - 收音机：只能收听，不能发送
  - 对讲机：收发，范围3km
  - 营地电台：范围扩大
  - 卫星通讯：全球范围
- 升级需消耗资源

**验收标准：**
- 设备等级限制通讯功能正确
- 低等级设备无法执行高等级操作并给出提示

---

### 3.14 个人主页

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |

**功能描述：**
- 开拓者档案展示：
  - 幸存者等级
  - 存活天数
  - 领地数量和总面积
  - 建筑数量

**验收标准：**
- 数据实时更新
- 统计数据准确

---

### 3.15 多语言支持

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |

**功能描述：**
- 支持语言：简体中文、繁体中文、英文
- 设置中可切换语言
- 切换后应用重启，全部文字更新

**验收标准：**
- 所有界面文字均已翻译
- 语言切换后无遗漏的未翻译文本

---

### 3.16 付费订阅系统

| 项目 | 说明 |
|------|------|
| 优先级 | P0（必须） |
| 技术方案 | StoreKit 2 |

**功能描述：**
- 订阅制：
  - 开拓者月卡 $9.99/月：无限探索、范围扩大
  - 领主通行证 $19.99/月：所有特权
- 一次性购买（资源包）：
  - 初级物资包 $0.99
  - 中级物资包 $2.99
  - 稀有资源包 $9.99
- 支持自动续费、家庭共享

**验收标准：**
- 支付流程符合苹果审核要求
- 订阅状态正确管理
- 购买后资源/权益即时到账

---

### 3.17 排行榜

| 项目 | 说明 |
|------|------|
| 优先级 | P2（一般） |

**功能描述：**
- 三个榜单：
  - 领地面积榜
  - 探索废墟榜
  - 建筑数量榜
- 显示玩家排名、数据
- 5分钟缓存更新机制

**验收标准：**
- 排行数据准确
- 10万用户量级下查询响应 < 1秒

---

### 3.18 成就系统

| 项目 | 说明 |
|------|------|
| 优先级 | P2（一般） |

**功能描述：**
- 成就分类：新手成就、进阶成就、稀有成就
- 成就稀有度：普通 → 稀有 → 史诗 → 传说
- 完成成就获得金币奖励
- 显示总体完成度
- 基于EventBus事件驱动触发

**验收标准：**
- 成就触发逻辑正确
- 奖励正确发放

---

### 3.19 生存体征系统

| 项目 | 说明 |
|------|------|
| 优先级 | P1（重要） |

**功能描述：**
- 三项核心指标：
  - 核心生命：100点满值，降到0角色死亡
  - 饱食度：随时间下降，每小时-5
  - 水分：随时间下降，每小时-10
- 饱食度/水分低于阈值时掉血
- 饱食度/水分 > 80%时获得增益效果
- 通过食物和水补充

**验收标准：**
- 数值衰减计算准确（含离线时间补算）
- 增益/惩罚效果正确生效
- 每10分钟定时检查一次

---

## 4. 技术架构

| 层级 | 技术选型 |
|------|----------|
| 前端 | Swift / SwiftUI（iOS原生） |
| 地图 | Apple MapKit（免费，全球可用） |
| 定位 | CoreLocation + 地理围栏 |
| 后端 | Supabase（BaaS） |
| 数据库 | PostgreSQL + PostGIS |
| 认证 | Supabase Auth（OAuth） |
| 实时通讯 | Supabase Realtime |
| 支付 | StoreKit 2 |
| 架构模式 | 本地优先 + 云端同步 |

---

## 5. 核心代码模块

| 功能模块 | 核心文件 |
|----------|----------|
| 登录注册 | AuthManager.swift |
| GPS圈地 | LocationManager.swift |
| 领地管理 | TerritoryManager.swift |
| POI发现 | POIManager.swift |
| 探索搜刮 | ExplorationManager.swift |
| 背包系统 | ItemManager.swift |
| 建造系统 | BuildingManager.swift |
| 交易系统 | TradeManager.swift |
| 消息中心 | RadioManager.swift |
| 实时聊天 | CommunicationManager.swift |
| 频道管理 | ChannelManager.swift |
| 内购支付 | StoreKitManager.swift |
| 排行榜 | LeaderboardManager.swift |
| 成就系统 | AchievementManager.swift |
| 生存体征 | VitalSignsManagerV2.swift |

---

## 6. 商业模式

### 6.1 收入来源
- **订阅收入**：月卡 $9.99、通行证 $19.99
- **内购收入**：资源包 $0.99 - $9.99
- **付费道具**：通讯设备升级、背包扩容、减缓体征衰减

### 6.2 用户增长策略
- 排行榜驱动竞争和分享
- 成就系统引导新手，提升留存
- 基于位置的社交促进口碑传播
- 多语言支持覆盖全球市场

---

## 7. 版本规划

| 版本 | 功能范围 | 优先级 |
|------|----------|--------|
| v1.0 | 登录、圈地、探索搜刮、背包、建造、生存体征、支付 | P0 |
| v1.1 | 交易、消息中心、公共频道、个人主页、多语言 | P1 |
| v1.2 | 频道管理、PTT呼叫、设备等级、排行榜、成就 | P2 |
